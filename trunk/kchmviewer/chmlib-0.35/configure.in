# Process this file with autoconf to produce a configure script.
AC_INIT

# Checks for programs.
AC_PROG_CC
AC_PROG_INSTALL
AC_PROG_RANLIB
AC_CHECK_PROG(AR,ar,ar,:)

# Checks for header files.
AC_CHECK_HEADERS(string.h strings.h unistd.h)

# PR_CHECK_CC_OPT
# ---------------------
# Check whether the C compiler accepts the given option
AC_DEFUN(PR_CHECK_CC_OPT,
  [AC_MSG_CHECKING([whether ${CC-cc} accepts -[$1]])
   echo 'void f(){}' > conftest.c
   if test -z "`${CC-cc} -c -$1 conftest.c 2>&1`"; then
     AC_MSG_RESULT(yes)
     CFLAGS="$CFLAGS -$1"
   else
     AC_MSG_RESULT(no)
   fi
   rm -f conftest*
  ])

dnl Enable developer code (e.g. core dumps)
ac_devel_cflags="-g -Wall"

AC_ARG_ENABLE(devel,
  [AC_HELP_STRING(
    [--enable-devel],
    [enable code of interest to developers])
  ],
  [
    if test x"$enableval" = xyes ; then
      devel="yes"
    else
      devel="no"
    fi
  ])

dnl default defines
CHM_MT="-DCHM_MT"
CHM_USE_PREAD="-DCHM_USE_PREAD"
CHM_USE_IO64="-DCHM_USE_IO64"
DMALLOC_DISABLE="-DDMALLOC_DISABLE"

dnl With chmLib
EXAMPLES="test_chmLib enum_chmLib enumdir_chmLib extract_chmLib"
LDFLAGS="$LDFLAGS"
AC_ARG_ENABLE(pthread,
  [AC_HELP_STRING(
    [--disable-pthread],
    [disable pthreads and do not build thread safe library])
  ],
  [
   if test "$enableval" = "yes"; then
      AC_CHECK_LIB(pthread,pthread_mutex_init)
      EXAMPLES="$EXAMPLES chm_http"
      LDFLAGS="$LDFLAGS -lpthread"
     else
      CHM_MT=""
      AC_MSG_WARN(Thread safe mode turned off. chm_http will not be built)
   fi
  ],
  [
   AC_CHECK_LIB(pthread,pthread_mutex_init)
   EXAMPLES="$EXAMPLES chm_http"
   LDFLAGS="$LDFLAGS -lpthread"
  ])

AC_ARG_ENABLE(io64,
  [AC_HELP_STRING(
    [--disable-io64],
    [do not build chm_lib with support of 64-bit file I/O])
  ],
  [
   if test "$enableval" = "no"; then
      CHM_USE_IO64=""
   fi
  ])

AC_ARG_ENABLE(pread,
  [AC_HELP_STRING(
    [--disable-pread],
    [do not build chm_lib to use pread/pread64 for all I/O])
  ],
  [
   if test "$enableval" = "no"; then
      CHM_USE_PREAD=""
   fi
  ])

AC_ARG_ENABLE(dmalloc,
  [AC_HELP_STRING(
    [--enable-dmalloc],
    [enable dmalloc])
  ],
  [
   if test "$enableval" = "yes"; then
      DMALLOC_DISABLE=""
   fi
  ])


AC_SUBST(EXAMPLES)
AC_SUBST(CHM_MT)
AC_SUBST(CHM_USE_PREAD)
AC_SUBST(CHM_USE_IO64)
AC_SUBST(DMALLOC_DISABLE)


# Checks for typedefs, structures, and compiler characteristics.
AC_TYPE_SIZE_T

# Checks for library functions.
AC_FUNC_MALLOC

dnl Checks for installation user/group

if test x"$install_user" = x; then
  if test "x$target_os" = "xcygwin"; then
    install_user=Administrator
  else
    install_user=root
  fi
fi
if test x"$install_group" = x ; then
        install_group=`sed -n '/.*:.*:0:/{s/^\(.*\):.*:0:.*/\1/p;q;}' /etc/group 2>/dev/null`
fi

AC_SUBST(install_user)
AC_SUBST(install_group)

if test x"$devel" = xyes ; then
  AC_DEFINE(USE_DEVEL)

  if test x"$GCC" = xyes; then

    dnl Remove any optimization flags from CFLAGS
    CFLAGS=`echo "$CFLAGS" | sed -e 's/\-O2//'`
    CFLAGS="$CFLAGS $ac_devel_cflags"

    dnl Some C compilers (e.g. older gcc versions) may not accept these
    dnl options.  Check if they are supported.  They will be added to
    dnl CFLAGS if supported.
    PR_CHECK_CC_OPT(Wfloat-equal)
  fi

  dnl Do not strip symboles from developer object files.
  INSTALL_STRIP=""
else

  dnl Make sure to strip symbols from non-developer object files.
  INSTALL_STRIP="-s"
fi

AC_PROG_LD
AC_SUBST(LD)

AC_SUBST(INSTALL_STRIP)

top_builddir=`pwd`
AC_SUBST(top_builddir)

AC_OUTPUT(Makefile)
